!function(e){function n(){this._pieces=[],this._parts=[]}function r(e){this.index=0,this.dataBuffer=e,this.dataView=new Uint8Array(this.dataBuffer),this.length=this.dataBuffer.byteLength}function i(){this.bufferBuilder=new n}function s(e){var t=e.charCodeAt(0);return 2047>=t?"00":65535>=t?"000":2097151>=t?"0000":67108863>=t?"00000":"000000"}function o(e){return e.length>600?new Blob([e]).size:e.replace(/[^\u0000-\u007F]/g,s).length}function u(){this._events={}}function l(){u.call(this)}function c(e,t){l.call(this),t=f.extend({readDelay:0,paused:!1},t),this._source=e,this._start=0,this._readChunkSize=t.chunkSize||e.size,this._readDelay=t.readDelay,this.readable=!0,this.paused=t.paused,this._read()}function h(e,t,n,r){if(!(this instanceof h))return new h(options);l.call(this),this.id=t,this._socket=e,this.writable=!0,this.readable=!0,this.paused=!1,this._closed=!1,this._ended=!1,n&&this._write(1,r,this.id)}function p(e,t){if(!(this instanceof p))return new p(e,t);u.call(this);var n=this;this._options=f.extend({chunkSize:40960},t),this.streams={},"string"==typeof e?(this._nextId=0,this._socket=new WebSocket(e)):(this._nextId=1,this._socket=e),this._socket.binaryType="arraybuffer",this._socket.addEventListener("open",function(){n.emit("open")}),this._socket.addEventListener("error",function(e){for(var t=Object.keys(n.streams),r=0,i=t.length;i>r;r++)n.streams[t[r]]._onError(e);n.emit("error",e)}),this._socket.addEventListener("close",function(e,t){for(var r=Object.keys(n.streams),i=0,s=r.length;s>i;i++)n.streams[r[i]]._onClose();n.emit("close",e,t)}),this._socket.addEventListener("message",function(e){f.setZeroTimeout(function(){e=e.data;try{e=f.unpack(e)}catch(t){return n.emit("error",new Error("Received unparsable message: "+t))}if(!(e instanceof Array))return n.emit("error",new Error("Received non-array message"));if(3!=e.length)return n.emit("error",new Error("Received message with wrong part count: "+e.length));if("number"!=typeof e[0])return n.emit("error",new Error("Received message with non-number type: "+e[0]));switch(e[0]){case 0:break;case 1:var r=e[1],i=e[2],s=n._receiveStream(i);n.emit("stream",s,r);break;case 2:var o=e[1],i=e[2],s=n.streams[i];s?s._onData(o):n.emit("error",new Error("Received `data` message for unknown stream: "+i));break;case 3:var i=e[2],s=n.streams[i];s?s._onPause():n.emit("error",new Error("Received `pause` message for unknown stream: "+i));break;case 4:var i=e[2],s=n.streams[i];s?s._onResume():n.emit("error",new Error("Received `resume` message for unknown stream: "+i));break;case 5:var i=e[2],s=n.streams[i];s?s._onEnd():n.emit("error",new Error("Received `end` message for unknown stream: "+i));break;case 6:var i=e[2],s=n.streams[i];s?s._onClose():n.emit("error",new Error("Received `close` message for unknown stream: "+i));break;default:n.emit("error",new Error("Unrecognized message type received: "+e[0]))}})})}var t={};t.useBlobBuilder=function(){try{return new Blob([]),!1}catch(e){return!0}}(),t.useArrayBufferView=!t.useBlobBuilder&&function(){try{return 0===new Blob([new Uint8Array([])]).size}catch(e){return!0}}(),t.supportsBinaryWebsockets=function(){try{var e=new WebSocket("ws://null");return e.onerror=function(){},"undefined"!=typeof e.binaryType?!0:!1}catch(t){return!1}}(),e.binaryFeatures=t,e.BlobBuilder=window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder||window.BlobBuilder,n.prototype.append=function(e){"number"==typeof e?this._pieces.push(e):(this.flush(),this._parts.push(e))},n.prototype.flush=function(){if(this._pieces.length>0){var e=new Uint8Array(this._pieces);t.useArrayBufferView||(e=e.buffer),this._parts.push(e),this._pieces=[]}},n.prototype.getBuffer=function(){if(this.flush(),t.useBlobBuilder){for(var e=new BlobBuilder,n=0,r=this._parts.length;r>n;n++)e.append(this._parts[n]);return e.getBlob()}return new Blob(this._parts)},e.BinaryPack={unpack:function(e){var t=new r(e);return t.unpack()},pack:function(e){var t=new i;t.pack(e);var n=t.getBuffer();return n}},r.prototype.unpack=function(){var e=this.unpack_uint8();if(128>e){var t=e;return t}if(32>(224^e)){var n=(224^e)-32;return n}var r;if((r=160^e)<=15)return this.unpack_raw(r);if((r=176^e)<=15)return this.unpack_string(r);if((r=144^e)<=15)return this.unpack_array(r);if((r=128^e)<=15)return this.unpack_map(r);switch(e){case 192:return null;case 193:return void 0;case 194:return!1;case 195:return!0;case 202:return this.unpack_float();case 203:return this.unpack_double();case 204:return this.unpack_uint8();case 205:return this.unpack_uint16();case 206:return this.unpack_uint32();case 207:return this.unpack_uint64();case 208:return this.unpack_int8();case 209:return this.unpack_int16();case 210:return this.unpack_int32();case 211:return this.unpack_int64();case 212:return void 0;case 213:return void 0;case 214:return void 0;case 215:return void 0;case 216:return r=this.unpack_uint16(),this.unpack_string(r);case 217:return r=this.unpack_uint32(),this.unpack_string(r);case 218:return r=this.unpack_uint16(),this.unpack_raw(r);case 219:return r=this.unpack_uint32(),this.unpack_raw(r);case 220:return r=this.unpack_uint16(),this.unpack_array(r);case 221:return r=this.unpack_uint32(),this.unpack_array(r);case 222:return r=this.unpack_uint16(),this.unpack_map(r);case 223:return r=this.unpack_uint32(),this.unpack_map(r)}},r.prototype.unpack_uint8=function(){var e=255&this.dataView[this.index];return this.index++,e},r.prototype.unpack_uint16=function(){var e=this.read(2),t=256*(255&e[0])+(255&e[1]);return this.index+=2,t},r.prototype.unpack_uint32=function(){var e=this.read(4),t=256*(256*(256*e[0]+e[1])+e[2])+e[3];return this.index+=4,t},r.prototype.unpack_uint64=function(){var e=this.read(8),t=256*(256*(256*(256*(256*(256*(256*e[0]+e[1])+e[2])+e[3])+e[4])+e[5])+e[6])+e[7];return this.index+=8,t},r.prototype.unpack_int8=function(){var e=this.unpack_uint8();return 128>e?e:e-256},r.prototype.unpack_int16=function(){var e=this.unpack_uint16();return 32768>e?e:e-65536},r.prototype.unpack_int32=function(){var e=this.unpack_uint32();return e<Math.pow(2,31)?e:e-Math.pow(2,32)},r.prototype.unpack_int64=function(){var e=this.unpack_uint64();return e<Math.pow(2,63)?e:e-Math.pow(2,64)},r.prototype.unpack_raw=function(e){if(this.length<this.index+e)throw new Error("BinaryPackFailure: index is out of range "+this.index+" "+e+" "+this.length);var t=this.dataBuffer.slice(this.index,this.index+e);return this.index+=e,t},r.prototype.unpack_string=function(e){for(var i,s,t=this.read(e),n=0,r="";e>n;)i=t[n],128>i?(r+=String.fromCharCode(i),n++):32>(192^i)?(s=(192^i)<<6|63&t[n+1],r+=String.fromCharCode(s),n+=2):(s=(15&i)<<12|(63&t[n+1])<<6|63&t[n+2],r+=String.fromCharCode(s),n+=3);return this.index+=e,r},r.prototype.unpack_array=function(e){for(var t=new Array(e),n=0;e>n;n++)t[n]=this.unpack();return t},r.prototype.unpack_map=function(e){for(var t={},n=0;e>n;n++){var r=this.unpack(),i=this.unpack();t[r]=i}return t},r.prototype.unpack_float=function(){var e=this.unpack_uint32(),t=e>>31,n=(e>>23&255)-127,r=8388607&e|8388608;return(0==t?1:-1)*r*Math.pow(2,n-23)},r.prototype.unpack_double=function(){var e=this.unpack_uint32(),t=this.unpack_uint32(),n=e>>31,r=(e>>20&2047)-1023,i=1048575&e|1048576,s=i*Math.pow(2,r-20)+t*Math.pow(2,r-52);return(0==n?1:-1)*s},r.prototype.read=function(e){var t=this.index;if(t+e<=this.length)return this.dataView.subarray(t,t+e);throw new Error("BinaryPackFailure: read index out of range")},i.prototype.getBuffer=function(){return this.bufferBuilder.getBuffer()},i.prototype.pack=function(e){var n=typeof e;if("string"==n)this.pack_string(e);else if("number"==n)Math.floor(e)===e?this.pack_integer(e):this.pack_double(e);else if("boolean"==n)e===!0?this.bufferBuilder.append(195):e===!1&&this.bufferBuilder.append(194);else if("undefined"==n)this.bufferBuilder.append(192);else{if("object"!=n)throw new Error('Type "'+n+'" not yet supported');if(null===e)this.bufferBuilder.append(192);else{var r=e.constructor;if(r==Array)this.pack_array(e);else if(r==Blob||r==File)this.pack_bin(e);else if(r==ArrayBuffer)this.pack_bin(t.useArrayBufferView?new Uint8Array(e):e);else if("BYTES_PER_ELEMENT"in e)this.pack_bin(t.useArrayBufferView?new Uint8Array(e.buffer):e.buffer);else if(r==Object)this.pack_object(e);else if(r==Date)this.pack_string(e.toString());else{if("function"!=typeof e.toBinaryPack)throw new Error('Type "'+r.toString()+'" not yet supported');this.bufferBuilder.append(e.toBinaryPack())}}}this.bufferBuilder.flush()},i.prototype.pack_bin=function(e){var t=e.length||e.byteLength||e.size;if(15>=t)this.pack_uint8(160+t);else if(65535>=t)this.bufferBuilder.append(218),this.pack_uint16(t);else{if(!(4294967295>=t))throw new Error("Invalid length");this.bufferBuilder.append(219),this.pack_uint32(t)}this.bufferBuilder.append(e)},i.prototype.pack_string=function(e){var t=o(e);if(15>=t)this.pack_uint8(176+t);else if(65535>=t)this.bufferBuilder.append(216),this.pack_uint16(t);else{if(!(4294967295>=t))throw new Error("Invalid length");this.bufferBuilder.append(217),this.pack_uint32(t)}this.bufferBuilder.append(e)},i.prototype.pack_array=function(e){var t=e.length;if(15>=t)this.pack_uint8(144+t);else if(65535>=t)this.bufferBuilder.append(220),this.pack_uint16(t);else{if(!(4294967295>=t))throw new Error("Invalid length");this.bufferBuilder.append(221),this.pack_uint32(t)}for(var n=0;t>n;n++)this.pack(e[n])},i.prototype.pack_integer=function(e){if(e>=-32&&127>=e)this.bufferBuilder.append(255&e);else if(e>=0&&255>=e)this.bufferBuilder.append(204),this.pack_uint8(e);else if(e>=-128&&127>=e)this.bufferBuilder.append(208),this.pack_int8(e);else if(e>=0&&65535>=e)this.bufferBuilder.append(205),this.pack_uint16(e);else if(e>=-32768&&32767>=e)this.bufferBuilder.append(209),this.pack_int16(e);else if(e>=0&&4294967295>=e)this.bufferBuilder.append(206),this.pack_uint32(e);else if(e>=-2147483648&&2147483647>=e)this.bufferBuilder.append(210),this.pack_int32(e);else if(e>=-0x8000000000000000&&0x8000000000000000>=e)this.bufferBuilder.append(211),this.pack_int64(e);else{if(!(e>=0&&0x10000000000000000>=e))throw new Error("Invalid integer");this.bufferBuilder.append(207),this.pack_uint64(e)}},i.prototype.pack_double=function(e){var t=0;0>e&&(t=1,e=-e);var n=Math.floor(Math.log(e)/Math.LN2),r=e/Math.pow(2,n)-1,i=Math.floor(r*Math.pow(2,52)),s=Math.pow(2,32),o=t<<31|n+1023<<20|i/s&1048575,u=i%s;this.bufferBuilder.append(203),this.pack_int32(o),this.pack_int32(u)},i.prototype.pack_object=function(e){var t=Object.keys(e),n=t.length;if(15>=n)this.pack_uint8(128+n);else if(65535>=n)this.bufferBuilder.append(222),this.pack_uint16(n);else{if(!(4294967295>=n))throw new Error("Invalid length");this.bufferBuilder.append(223),this.pack_uint32(n)}for(var r in e)e.hasOwnProperty(r)&&(this.pack(r),this.pack(e[r]))},i.prototype.pack_uint8=function(e){this.bufferBuilder.append(e)},i.prototype.pack_uint16=function(e){this.bufferBuilder.append(e>>8),this.bufferBuilder.append(255&e)},i.prototype.pack_uint32=function(e){var t=4294967295&e;this.bufferBuilder.append((4278190080&t)>>>24),this.bufferBuilder.append((16711680&t)>>>16),this.bufferBuilder.append((65280&t)>>>8),this.bufferBuilder.append(255&t)},i.prototype.pack_uint64=function(e){var t=e/Math.pow(2,32),n=e%Math.pow(2,32);this.bufferBuilder.append((4278190080&t)>>>24),this.bufferBuilder.append((16711680&t)>>>16),this.bufferBuilder.append((65280&t)>>>8),this.bufferBuilder.append(255&t),this.bufferBuilder.append((4278190080&n)>>>24),this.bufferBuilder.append((16711680&n)>>>16),this.bufferBuilder.append((65280&n)>>>8),this.bufferBuilder.append(255&n)},i.prototype.pack_int8=function(e){this.bufferBuilder.append(255&e)},i.prototype.pack_int16=function(e){this.bufferBuilder.append((65280&e)>>8),this.bufferBuilder.append(255&e)},i.prototype.pack_int32=function(e){this.bufferBuilder.append(e>>>24&255),this.bufferBuilder.append((16711680&e)>>>16),this.bufferBuilder.append((65280&e)>>>8),this.bufferBuilder.append(255&e)},i.prototype.pack_int64=function(e){var t=Math.floor(e/Math.pow(2,32)),n=e%Math.pow(2,32);this.bufferBuilder.append((4278190080&t)>>>24),this.bufferBuilder.append((16711680&t)>>>16),this.bufferBuilder.append((65280&t)>>>8),this.bufferBuilder.append(255&t),this.bufferBuilder.append((4278190080&n)>>>24),this.bufferBuilder.append((16711680&n)>>>16),this.bufferBuilder.append((65280&n)>>>8),this.bufferBuilder.append(255&n)};var a=Array.isArray;u.prototype.addListener=function(e,t){if("function"!=typeof t)throw new Error("addListener only takes instances of Function");this.emit("newListener",e,"function"==typeof t.listener?t.listener:t),this._events[e]?a(this._events[e])?this._events[e].push(t):this._events[e]=[this._events[e],t]:this._events[e]=t},u.prototype.on=u.prototype.addListener,u.prototype.once=function(e,t){function i(){r.removeListener(e,i),t.apply(this,arguments)}if("function"!=typeof t)throw new Error(".once only takes instances of Function");var r=this;return i.listener=t,r.on(e,i),this},u.prototype.removeListener=function(e,t){if("function"!=typeof t)throw new Error("removeListener only takes instances of Function");if(!this._events[e])return this;var r=this._events[e];if(a(r)){for(var i=-1,s=0,o=r.length;o>s;s++)if(r[s]===t||r[s].listener&&r[s].listener===t){i=s;break}if(0>i)return this;r.splice(i,1),0==r.length&&delete this._events[e]}else(r===t||r.listener&&r.listener===t)&&delete this._events[e];return this},u.prototype.off=u.prototype.removeListener,u.prototype.removeAllListeners=function(e){return 0===arguments.length?(this._events={},this):(e&&this._events&&this._events[e]&&(this._events[e]=null),this)},u.prototype.listeners=function(e){return this._events[e]||(this._events[e]=[]),a(this._events[e])||(this._events[e]=[this._events[e]]),this._events[e]},u.prototype.emit=function(e){var e=arguments[0],t=this._events[e];if(!t)return!1;if("function"==typeof t){switch(arguments.length){case 1:t.call(this);break;case 2:t.call(this,arguments[1]);break;case 3:t.call(this,arguments[1],arguments[2]);break;default:for(var n=arguments.length,r=new Array(n-1),i=1;n>i;i++)r[i-1]=arguments[i];t.apply(this,r)}return!0}if(a(t)){for(var n=arguments.length,r=new Array(n-1),i=1;n>i;i++)r[i-1]=arguments[i];for(var s=t.slice(),i=0,n=s.length;n>i;i++)s[i].apply(this,r);return!0}return!1};var f={inherits:function(e,t){e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}})},extend:function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e},pack:BinaryPack.pack,unpack:BinaryPack.unpack,setZeroTimeout:function(e){function r(r){t.push(r),e.postMessage(n,"*")}function i(r){r.source==e&&r.data==n&&(r.stopPropagation&&r.stopPropagation(),t.length&&t.shift()())}var t=[],n="zero-timeout-message";return e.addEventListener?e.addEventListener("message",i,!0):e.attachEvent&&e.attachEvent("onmessage",i),r}(this)};f.inherits(l,u),l.prototype.pipe=function(e,t){function r(t){e.writable&&!1===e.write(t)&&n.pause&&n.pause()}function i(){n.readable&&n.resume&&n.resume()}function o(){s||(s=!0,e.end())}function u(){s||(s=!0,e.destroy())}function a(e){if(f(),0===this.listeners("error").length)throw e}function f(){n.removeListener("data",r),e.removeListener("drain",i),n.removeListener("end",o),n.removeListener("close",u),n.removeListener("error",a),e.removeListener("error",a),n.removeListener("end",f),n.removeListener("close",f),e.removeListener("end",f),e.removeListener("close",f)}var n=this;n.on("data",r),e.on("drain",i),!e._isStdio&&(!t||t.end!==!1)&&(n.on("end",o),n.on("close",u));var s=!1;return n.on("error",a),e.on("error",a),n.on("end",f),n.on("close",f),e.on("end",f),e.on("close",f),e.emit("pipe",n),e},f.inherits(c,l),c.prototype.pause=function(){this.paused=!0},c.prototype.resume=function(){this.paused=!1,this._read()},c.prototype.destroy=function(){this.readable=!1,clearTimeout(this._timeoutId)},c.prototype._read=function(){function t(){e._emitReadChunk()}var e=this,n=this._readDelay;0!==n?this._timeoutId=setTimeout(t,n):f.setZeroTimeout(t)},c.prototype._emitReadChunk=function(){if(!this.paused&&this.readable){var e=Math.min(this._source.size-this._start,this._readChunkSize);if(0===e)return this.readable=!1,void this.emit("end");var t=this._start+e,n=(this._source.slice||this._source.webkitSlice||this._source.mozSlice).call(this._source,this._start,t);this._start=t,this._read(),this.emit("data",n)}},e.BlobReadStream=c,f.inherits(h,l),h.prototype._onDrain=function(){this.paused||this.emit("drain")},h.prototype._onClose=function(){this._closed||(this.readable=!1,this.writable=!1,this._closed=!0,this.emit("close"))},h.prototype._onError=function(e){this.readable=!1,this.writable=!1,this.emit("error",e)},h.prototype._onPause=function(){this.paused=!0,this.emit("pause")},h.prototype._onResume=function(){this.paused=!1,this.emit("resume"),this.emit("drain")},h.prototype._write=function(e,t,n){if(this._socket.readyState!==this._socket.constructor.OPEN)return!1;var r=f.pack([e,t,n]);return this._socket.send(r)!==!1},h.prototype.write=function(e){if(this.writable){var t=this._write(2,e,this.id);return!this.paused&&t}throw new Error("Stream is not writable")},h.prototype.end=function(){this._ended=!0,this.readable=!1,this._write(5,null,this.id)},h.prototype.destroy=h.prototype.destroySoon=function(){this._onClose(),this._write(6,null,this.id)},h.prototype._onEnd=function(){this._ended||(this._ended=!0,this.readable=!1,this.emit("end"))},h.prototype._onData=function(e){this.emit("data",e)},h.prototype.pause=function(){this._onPause(),this._write(3,null,this.id)},h.prototype.resume=function(){this._onResume(),this._write(4,null,this.id)},f.inherits(p,u),p.prototype.send=function(e,n){var r=this.createStream(n);if(e instanceof l)e.pipe(r);else if(f.isNode===!0)Buffer.isBuffer(e)?new BufferReadStream(e,{chunkSize:this._options.chunkSize}).pipe(r):r.write(e);else if(f.isNode!==!0)if(e.constructor==Blob||e.constructor==File)new c(e,{chunkSize:this._options.chunkSize}).pipe(r);else if(e.constructor==ArrayBuffer){var i;if(t.useArrayBufferView&&(e=new Uint8Array(e)),t.useBlobBuilder){var s=new BlobBuilder;s.append(e),i=s.getBlob()}else i=new Blob([e]);new c(i,{chunkSize:this._options.chunkSize}).pipe(r)}else if("object"==typeof e&&"BYTES_PER_ELEMENT"in e){var i;if(t.useArrayBufferView||(e=e.buffer),t.useBlobBuilder){var s=new BlobBuilder;s.append(e),i=s.getBlob()}else i=new Blob([e]);new c(i,{chunkSize:this._options.chunkSize}).pipe(r)}else r.write(e);return r},p.prototype._receiveStream=function(e){var t=this,n=new h(this._socket,e,!1);return n.on("close",function(){delete t.streams[e]}),this.streams[e]=n,n},p.prototype.createStream=function(e){if(this._socket.readyState!==WebSocket.OPEN)throw new Error("Client is not yet connected or has closed");var t=this,n=this._nextId;this._nextId+=2;var r=new h(this._socket,n,!0,e);return r.on("close",function(){delete t.streams[n]}),this.streams[n]=r,r},p.prototype.close=p.prototype.destroy=function(){this._socket.close()},e.BinaryClient=p}(this),function(root){"use strict";var defaults={ajax:{type:"post",contentType:!1,processData:!1,dataType:"json",url:"http://localhost:8000"},socket:!0,type:"BinaryString",originalFile:null,file:null,result:null,range:[0,0],parts:200,rest:20,restDuration:500,beforeStart:_.noop,afterCheck:_.noop,progress:_.noop,done:_.noop},FileManager=function(options){var ajax=_.extend({},defaults.ajax,options.ajax);_.extend(this,defaults,options),this.ajax=ajax,this.originalFile=this.file,this.size=this.originalFile.size,this.fileType=this.originalFile.type,this.range=[0,this.size],this.sessionID=0,this.fileID=0,this.client=new BinaryClient(this.ajax.url.replace("http://","ws://"),{chunkSize:1e3*options.parts});var _super=this;this.client.on("open",function(){_super.clientOpen=!0})};FileManager.prototype={_load:function(){var deferred=new jQuery.Deferred;this.fileReader=new FileReader;var self=this;return this.fileReader.onload=function(e){self.result=e.target.result,deferred.resolve(self)},this.fileReader.onerror=this.fileReader.onabort=function(e){deferred.reject(e)},this.fileReader["readAs"+this.type](this.file),deferred.promise()},load:function(){return this._load.apply(this,arguments)},_slice:function(start,end){return this.file=this.originalFile.slice(start,end),this.range=[start,end],this},slice:function(){return this._slice.apply(this,arguments)},_full:function(){return this.file=this.originalFile,this.range=[0,this.size],this},full:function(){return this._full.apply(this,arguments)},_check:function(from,to,options){var lastbits=this.originalFile.slice(from,to),fd=new FormData;fd.append("file",lastbits,this.originalFile.name),fd.append("range",from+"-"+to);var opts=_.extend({},this.ajax,options||{},{data:fd});return $.ajax(this.ajax.url+"/check",opts)},check:function(){return this._check.apply(this,arguments)},_sendAjax:function(options){var fd=new FormData;fd.append("file",this.file,this.fileID||this.originalFile.name),this.fileID||fd.append("size",this.size),fd.append("session",this.sessionID);var opts=_.extend({},this.ajax,options||{},{data:fd}),_self=this;return $.ajax(this.ajax.url+"/upload",opts).done(function(response){_self.sessionID||response&&response.session||(_self._abort=!0),!_self.sessionID&&response&&(_self.sessionID=response.session,_self.fileID=response.file),response&&0===response.status&&(_self._abort=!0)})},send:function(){return this._send.apply(this,arguments)},_upload:function(from,to,options){function loop(){return _super._abort?(_super._abort=!1,void deferred.reject(_super)):max?(_super.pause(!0),deferred.resolve(_super),void _super.done(_super)):(i+parts>to&&(max=!0),void _super.slice(i,max?to:i+parts).load().then(function(){function done(){i=max?to:i+parts,percentage=100*i/to,_super.progress({min:from,max:to,sent:i,percentage:percentage,_super:_super}),rest++,rest>=_super.rest?(setTimeout(loop,_super.restDuration),rest=0):loop()}function err(){deferred.reject.apply(deferred,arguments),_super._abort=!0}_super.send(opts.ajax).then(done,err)},function(err){deferred.reject(err),_super._abort=!0}))}this.beforeStart(this);var deferred=new jQuery.Deferred,opts=_.extend({},this,options);from=_.isNumber(from)?from:0,to=_.isNumber(to)?to:this.size;var parts=1e3*(parts||opts.parts),i=from,max=!1,_super=this,rest=0,percentage=100*i/to;if(this.socket)return this.clientOpened||this.client.on("open",function(){_super.upload(from,to,options)}),this.slice(from,to).load().then(function(){_super.client.send(_super.file,{file:_super.originalFile.name,size:_super.size})}),!0;if(i>0){var f=0>from-100?0:from-100;this.check(f,from).then(function(){_super.afterCheck(_super),loop()},deferred.reject)}else loop();return deferred.promise()},upload:function(){return this._upload.apply(this,arguments)},_pause:function(finished){return this._abort=!0,$.ajax(this.ajax.url+"/killSession",{data:{session:this.sessionID,finished:finished||!1}}),this},pause:function(){return this._pause.apply(this,arguments)},_resume:function(options){var _super=this,opts=_.extend({type:"post",data:{file:this.fileID},dataType:"text",mimeType:"text/plain"},options||{});return $.ajax(this.ajax.url+"/resume",opts).then(function(response){_super.upload(+response)})},resume:function(){return this._resume.apply(this,arguments)}},root.FileManager=FileManager}(this);